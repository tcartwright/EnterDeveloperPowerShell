name: Powershell Analyze and Publish 

on:
  workflow_dispatch:
      inputs:
        ModuleVersion:
          description: 'Module Version'     
          required: true
          default: ''
jobs:
  build:
    runs-on: windows-latest  

    steps:
    - name: Validate Version Input
      shell: powershell
      run: |
        $version, $suffix = "${{ github.event.inputs.ModuleVersion }}" -split "-", 2
        [Version]$version
    
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Update Version in PSD1
      shell: powershell
      run: |
        $fileName = "${{ github.workspace }}/EnterDeveloperPowerShell/EnterDeveloperPowerShell.psd1"
        $inputsVersion = "${{ github.event.inputs.ModuleVersion }}"
        $manifestContents =  Get-Content $fileName -raw
        $options = [System.Text.RegularExpressions.RegexOptions]::IgnoreCase -bor [System.Text.RegularExpressions.RegexOptions]::Multiline
        $matches = [Regex]::Matches($manifestContents, '(ModuleVersion\s*=\s*'')(.*?)(''.*$)', $options)
        $manifestContents = [Regex]::Replace($manifestContents, '(ModuleVersion\s*=\s*'')(.*?)(''.*$)', "`${1}$inputsVersion`${3}", $options)
        [System.IO.File]::WriteAllText($fileName, $manifestContents)
    
    - name: Run PSScriptAnalyzer
      shell: powershell
      run: |
        Import-Module PSScriptAnalyzer
        $results = Invoke-ScriptAnalyzer -path "${{ github.workspace }}" -Recurse -Fix 
        Write-Output $results
        $errors = $results | Where-Object { $_.Severity -ieq "Warning" -or $_.Severity -ieq "Error" } 
        if ($errors -and $errors.Count -gt 0) {
          throw "Problems were found in the powershell scripts. Please fix before running this build again."
          exit 1
        }
    
    - name: Publish Module to PowerShell Gallery
      shell: pwsh
      env:
        PSGALLERY_APIKEY: "${{ secrets.POWERSHELL_GALLERY_APIKEY }}"
      run: |
        Publish-Module -Path "${{ github.workspace }}/EnterDeveloperPowerShell/" -NuGetApiKey "$env:PSGALLERY_APIKEY" -Verbose
      
    - name: Commit changes  
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git diff-index --quiet HEAD || git commit -m "Updating changes made by build"   
    
    - name: Push changes  
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.HEAD_REF }}
        force: true

